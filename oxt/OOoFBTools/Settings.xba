<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="Settings" script:language="StarBasic">REM  *****  BASIC  *****
Option Explicit

Public sSettingsFilename As String

Private oCB As Object &apos; Для работы с ListBox`ами

Function pmxCurDir() As String
	&apos; Возвращает путь к папке конфигурации пользователя
	&apos; Для Windows - C:\Documents and Settings\vadim\Application Data\OpenOffice.org2\user\config\
	Dim oPathSettings
	oPathSettings = CreateUnoService(&quot;com.sun.star.util.PathSettings&quot;)
	pmxCurDir = oPathSettings.UserConfig&apos;Work
End Function
	
Function ReadSettings
	&apos; Читаем установки и задаем значения контролам
	If FileExists(sSettingsFilename) Then
		Dim iFileNo As Integer, sCurrentLine As String
		&apos; Установление свободного файлового манипулятора
		iFileNo = Freefile
		&apos; Открытие файла (в режиме на чтение)
		Open sSettingsFilename For Input As #iFileNo
		&apos; Проверка, был ли достигнут конец файла
		Do While NOT eof(iFileNo)
			&apos; Чтение строки
			Line Input #iFileNo, sCurrentLine
			If sCurrentLine &lt;&gt; &quot;&quot; Then
				&apos; Устанавливаем настройки
				SetSettings(sCurrentLine)
			End If
		Loop
		&apos; Закрытие файла
		Close #iFileNo
	End If
End Function

Function SetSettings(sCurrentLine)
	On Error Goto ErrorHandler
	Dim sSetting() As String
	sSetting = Split(sCurrentLine, &quot;=&quot;)
	
	If oServiceDlg.GetControl(sSetting(0)).getImplementationName() = &quot;stardiv.Toolkit.UnoCheckBoxControl&quot; Then
		oServiceDlg.GetControl(sSetting(0)).State = sSetting(1)
	ElseIf oServiceDlg.GetControl(sSetting(0)).getImplementationName() = &quot;stardiv.Toolkit.UnoComboBoxControl&quot; Then
		oServiceDlg.GetControl(sSetting(0)).Text = sSetting(1)
	ElseIf oServiceDlg.GetControl(sSetting(0)).getImplementationName() = &quot;stardiv.Toolkit.UnoRadioButtonControl&quot; Then
		oServiceDlg.GetControl(sSetting(0)).State = sSetting(1)
	ElseIf oServiceDlg.GetControl(sSetting(0)).getImplementationName() = &quot;stardiv.Toolkit.UnoListBoxControl&quot; Then
		oCB = oServiceDlg.getControl(sSetting(0))
		If oCB.Model.Name = &quot;cmbboxStyle&quot; Then
			Select Case sSetting(1)
				Case &quot;x&quot;
					oCB.SelectItemPos(0, True)
				Case &quot;[x]&quot;
					oCB.SelectItemPos(1, True)
				Case &quot;[ x ]&quot;
					oCB.SelectItemPos(2, True)
				Case &quot;{x}&quot;
					oCB.SelectItemPos(3, True)
				Case &quot;{ x }&quot;
					oCB.SelectItemPos(4, True)
				Case &quot;(x)&quot;
					oCB.SelectItemPos(5, True)
				Case &quot;( x )&quot;
					oCB.SelectItemPos(6, True)
			End Select
		Else
			Select Case sSetting(1)
				Case &quot;&quot;
					oCB.SelectItemPos(0, True)
				Case &quot;Слева&quot;
					If oCB.Model.Name = &quot;cmbboxAdjTextFrame&quot; Then
						oCB.SelectItemPos(0, True)
					Else
						oCB.SelectItemPos(1, True)
					End If
				Case &quot;По Центру&quot;
					If oCB.Model.Name = &quot;cmbboxAdjTextFrame&quot; Then
						oCB.SelectItemPos(1, True)
					Else
						oCB.SelectItemPos(2, True)
					End If
				Case &quot;Справа&quot;
					If oCB.Model.Name = &quot;cmbboxAdjTextFrame&quot; Then
						oCB.SelectItemPos(2, True)
					Else
						oCB.SelectItemPos(3, True)
					End If
				Case &quot;Сверху&quot;
					oCB.SelectItemPos(1, True)
				Case &quot;Снизу&quot;
					oCB.SelectItemPos(3, True)
				Case &quot;Таблица&quot;
					oCB.SelectItemPos(0, True)
				Case &quot;Текст&quot;
					oCB.SelectItemPos(1, True)
				Case &quot;Цитата&quot;
					oCB.SelectItemPos(2, True)
			End Select
		End If
	End If
	Exit Function
	ErrorHandler: &apos; идем дальше
End Function

Function SaveSettings
	&apos; записываем установки
	Dim iFileNo As Integer, sCurrentLine As String
	iFileNo = Freefile &apos; Установление свободного файлового манипулятора
	Open sSettingsFilename For Output As #iFileNo &apos; Открытие файла (в режиме на запись)
	
	Dim ctrl As Object, i As Integer
	ctrl = oServiceDlg.getControls()
	For i=LBound(ctrl) To UBound(ctrl)
		If ctrl(i).getImplementationName() = &quot;stardiv.Toolkit.UnoCheckBoxControl&quot; Then
			Print #iFileNo, ctrl(i).Model.Name &amp; &quot;=&quot; &amp; ctrl(i).Model.State
		ElseIf ctrl(i).getImplementationName() = &quot;stardiv.Toolkit.UnoComboBoxControl&quot; Then
			Print #iFileNo, ctrl(i).Model.Name &amp; &quot;=&quot; &amp; ctrl(i).Model.Text
		ElseIf ctrl(i).getImplementationName() = &quot;stardiv.Toolkit.UnoRadioButtonControl&quot; Then
			Print #iFileNo, ctrl(i).Model.Name &amp; &quot;=&quot; &amp; ctrl(i).Model.State
		ElseIf ctrl(i).getImplementationName() = &quot;stardiv.Toolkit.UnoListBoxControl&quot; Then
			Print #iFileNo, ctrl(i).Model.Name &amp; &quot;=&quot; &amp; ctrl(i).SelectedItem
		End If
	Next i
	
	Close #iFileNo &apos; Закрытие файла
End Function

Function SetDefaultSettingsInControls
	&apos; Настройки По умолчанию - в контролы
	&apos; Сноски
	oServiceDlg.Model.cboxStyleFootnote.State = 1
	oCB = oServiceDlg.getControl(&quot;cmbboxStyle&quot;)
	oCB.SelectItemPos(1, True)
	oServiceDlg.Model.cmbboxTitle.Text = &quot;Примечания&quot;
	oServiceDlg.Model.cboxSpace.State = 0
	oServiceDlg.Model.cboxNotesElements.State = 1
	&apos; Стихи
	oServiceDlg.Model.cboxPoemTitle.State = 0
	oServiceDlg.Model.cboxPoemAuthor.State = 0
	oServiceDlg.Model.cboxPoemSubtitle.State = 1
	&apos; Эпиграфы
	oServiceDlg.Model.cboxEpigAuthor.State = 0
	&apos; SubTitle
	oServiceDlg.Model.cboxSubtitle.State = 1
	&apos; Аннотации
	oServiceDlg.Model.cboxAnnotationSubtitle.State = 1
	&apos; Цитаты
	oServiceDlg.Model.cboxCiteAuthor.State = 0
	oServiceDlg.Model.cboxCiteSubtitle.State = 1
	&apos; Картинки
	oServiceDlg.Model.cboxImageTitle.State = 0
	&apos; Текстовые врезки
	oCB = oServiceDlg.getControl(&quot;cmbboxTextFrame&quot;)
	oCB.SelectItemPos(0, True)
	oCB = oServiceDlg.getControl(&quot;cmbboxAdjTextFrame&quot;)
	oCB.SelectItemPos(0, True)
	&apos; Таблицы
	oCB = oServiceDlg.getControl(&quot;cmbboxHeaderTRA&quot;)
	oCB.SelectItemPos(0, True)
	oCB = oServiceDlg.getControl(&quot;cmbboxHeaderTHV&quot;)
	oCB.SelectItemPos(0, True)
	oCB = oServiceDlg.getControl(&quot;cmbboxLineTRA&quot;)
	oCB.SelectItemPos(0, True)
	oCB = oServiceDlg.getControl(&quot;cmbboxLineTDV&quot;)
	oCB.SelectItemPos(0, True)
	&apos; Разное
	oServiceDlg.Model.cboxCorrect.State = 1
	oServiceDlg.Model.cboxDelEL.State = 0
	oServiceDlg.Model.cboxDocLinks.State = 1
	&apos; &quot;Служебная область&quot;
	oServiceDlg.Model.obtnUp.State = 1
	oServiceDlg.Model.obtnAny.State = 0
	
	&apos; Чистка fb2 кода
	oServiceDlg.Model.cboxSuperfluous.State = 1
	oServiceDlg.Model.cboxStyleSpace.State = 1
	
	lstboxTextFrameChange &apos; для доспупности вида выравнивания Текстовых Врезок
End Function

Function ReadSettingsInVars As Boolean
	&apos; Читаем настройки в переменные
	If FileExists(sSettingsFilename) Then
		Dim iFileNo As Integer, sCurrentLine As String
		&apos; Установление свободного файлового манипулятора
		iFileNo = Freefile
		&apos; Открытие файла (в режиме на чтение)
		Open sSettingsFilename For Input As #iFileNo
		&apos; Проверка, был ли достигнут конец файла
		Do While NOT eof(iFileNo)
			&apos; Чтение строки
			Line Input #iFileNo, sCurrentLine
			If sCurrentLine &lt;&gt; &quot;&quot; Then
				&apos; Устанавливаем данные стилей
				SetSettingsInVars(sCurrentLine)
			End If
		Loop
		&apos; Закрытие файла
		Close #iFileNo
		ReadSettingsInVars = True
	Else
		ReadSettingsInVars = False
	End If
End Function

Function SetSettingsInVars(sCurrentLine)
	Dim sSetting() As String
	sSetting = Split(sCurrentLine, &quot;=&quot;)
	Select Case sSetting(0)
		&apos; Сноски
		Case &quot;cboxStyleFootnote&quot;
			bStyleFootnote = sSetting(1)
		Case &quot;cboxNotesElements&quot;
			bNotesElements = sSetting(1)
		Case &quot;cmbboxStyle&quot;
			Select Case sSetting(1)
				Case &quot;x&quot;
					sFootnoteLeft = &quot;&quot;
					sFootnoteRight = &quot;&quot;
				Case &quot;[x]&quot;
					sFootnoteLeft = &quot;[&quot;
					sFootnoteRight = &quot;]&quot;
				Case &quot;[ x ]&quot;
					sFootnoteLeft = &quot;[ &quot;
					sFootnoteRight = &quot; ]&quot;
				Case &quot;{x}&quot;
					sFootnoteLeft = &quot;{&quot;
					sFootnoteRight = &quot;}&quot;
				Case &quot;{ x }&quot;
					sFootnoteLeft = &quot;{ &quot;
					sFootnoteRight = &quot; }&quot;
				Case &quot;(x)&quot;
					sFootnoteLeft = &quot;(&quot;
					sFootnoteRight = &quot;)&quot;
				Case &quot;( x )&quot;
					sFootnoteLeft = &quot;( &quot;
					sFootnoteRight = &quot; )&quot;
				Case Else
					sFootnoteLeft = &quot;[&quot;
					sFootnoteRight = &quot;]&quot;	
			End Select
		Case &quot;cboxSpace&quot;
			bFootnoteSpace = sSetting(1)
		Case &quot;cmbboxTitle&quot;
			sFootnoteTitle = sSetting(1)
		&apos; аннотация
		Case &quot;cboxAnnotationSubtitle&quot;
			bMergeAnnotationSubTitle = sSetting(1)
		&apos; Стихи
		Case &quot;cboxPoemTitle&quot;
			bMergePoemTitle = sSetting(1)
		Case &quot;cboxPoemAuthor&quot;
			bMergePoemAuthors = sSetting(1)
		Case &quot;cboxPoemSubtitle&quot;
			bMergePoemSubTitle = sSetting(1)
		&apos; Эпиграфы
		Case &quot;cboxEpigAuthor&quot;
			bMergeEpigraphAuthors = sSetting(1)
		&apos; SubTitle
		Case &quot;cboxSubtitle&quot;
			bMergeSubTitle = sSetting(1)
		&apos; Цитаты
		Case &quot;cboxCiteAuthor&quot;
			bMergeCiteAuthors = sSetting(1)
		Case &quot;cboxCiteSubtitle&quot;
			bMergeCiteSubTitle = sSetting(1)
		&apos; Картинки
		Case &quot;cboxImageTitle&quot;
			bSaveImageTitle = sSetting(1)
		&apos; Текстовые врезки
		Case &quot;cmbboxTextFrame&quot;
			Select Case sSetting(1)
				Case &quot;Таблица&quot;
					sTextFrameToFB2 = &quot;Таблица&quot;
				Case &quot;Текст&quot;
					sTextFrameToFB2 = &quot;Текст&quot;
				Case &quot;Цитата&quot;
					sTextFrameToFB2 = &quot;Цитата&quot;
				Case Else
					sTextFrameToFB2 = &quot;Таблица&quot;
			End Select
		Case &quot;cmbboxAdjTextFrame&quot;
			sAdjTextFrame = GetLCR(sSetting(1))
		&apos; Таблицы
		Case &quot;cmbboxHeaderTRA&quot;
			sHeaderTRA 	= GetLCR(sSetting(1))
		Case &quot;cmbboxHeaderTHV&quot;
			sHeaderTVA 	= GetTMB(sSetting(1))
		Case &quot;cmbboxLineTRA&quot;
			sLineTRA 	= GetLCR(sSetting(1))
		Case &quot;cmbboxLineTDV&quot;
			sLineTVA	= GetTMB(sSetting(1))
		&apos; Разное
		Case &quot;cboxCorrect&quot;
			bCorrectPara = sSetting(1)
		Case &quot;cboxDelEL&quot;
			bDelEL = sSetting(1)
		Case &quot;cboxDocLinks&quot;
			bDocLinks = sSetting(1)
		&apos; Чистка fb2 кода
		Case &quot;cboxSuperfluous&quot;
			bSuperfluous = sSetting(1)
		Case &quot;cboxStyleSpace&quot;
			bStyleSpace = sSetting(1)
		&apos; &quot;Служебная область&quot;
		Case &quot;obtnUp&quot;
			bUp = sSetting(1)
	End Select
End Function

Function GetLCR(sSetting) As String
	Select Case sSetting
		Case &quot;Слева&quot;
			GetLCR = &quot;left&quot;
		Case &quot;По Центру&quot;
			GetLCR = &quot;center&quot;
		Case &quot;Справа&quot;
			GetLCR = &quot;right&quot;
		Case Else
			GetLCR = &quot;&quot;
	End Select
End Function

Function GetTMB(sSetting) As String
	Select Case sSetting
		Case &quot;Сверху&quot;
			GetTMB = &quot;top&quot;
		Case &quot;По Центру&quot;
			GetTMB = &quot;middle&quot;
		Case &quot;Снизу&quot;
			GetTMB = &quot;bottom&quot;
		Case Else
			GetTMB =  &quot;&quot;
	End Select
End Function

Function SetDefaultSettingsInVars
	&apos; значения по умолчанию для сносок	
	sFootnoteLeft = &quot;[&quot;
	sFootnoteRight = &quot;]&quot;
	bFootnoteSpace = False
	sFootnoteTitle = &quot;Примечания&quot;
	bNotesElements = True
	&apos; значения по умолчанию для аннотации
	bMergeAnnotationSubTitle = True
	&apos; значения по умолчанию для SubTitle
	bMergeSubTitle = True
	&apos; значения по умолчанию для Авторов епиграфа
	bMergeEpigraphAuthors = False
	&apos; значения по умолчанию для заголовков стихов
	bMergePoemTitle = False
	&apos; значения по умолчанию для авторов стихов
	bMergePoemAuthors = False
	bMergePoemSubTitle = True
	&apos; значения по умолчанию для авторов цитат
	bMergeCiteAuthors = False
	bMergeCiteSubTitle = True
	&apos; значения по умолчанию для удаления пустых строк
	bDelEL = False
	&apos; значения по умолчанию для применения стиля к тексту сносок
	bStyleFootnote = True
	&apos; значения по умолчанию для обработкb &quot;проблемных&quot; знаков (&lt; &gt;)
	bCorrectPara = True
	&apos; значения по умолчанию для сохранения названия картинки, как аттрибута &quot;title&apos;
	bSaveImageTitle = False
	&apos; значение по умолчанию для обработки ссылок внутри документа
	bDocLinks = True
	
	&apos; значения по умолчанию для выравнивания элементов таблиц
	sHeaderTRA	 = &quot;&quot;
	sLineTRA	 = &quot;&quot;
	sHeaderTVA	 = &quot;&quot;
	sLineTVA	 = &quot;&quot;

	sTextFrameToFB2	 = &quot;Таблица&quot;
	sAdjTextFrame	 = &quot;left&quot;
	
	&apos; Чистка fb2 кода
	bSuperfluous = True
	bStyleSpace = True
	
	&apos; &quot;Служебная область&quot; сверху документа до Автора Книги или Названия Книги
	bUp	= True
	
End Function

</script:module>