<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="Profile" script:language="StarBasic">REM  *****  BASIC  *****
Option Explicit

&apos; читаем профиль
Sub _ReadProfile( sFilename As String, nN As Integer )
	&apos; nN - идентификатор типа профиля: 0 - для Автора Книги, 1 - для Автора fb2-документа, 2 - для Издательства
	If FileExists(sFilename) Then
		Dim sLine As String
		Dim oSFA As Object, oFS As Object, oTIS As Object

		oSFA = createUnoService ( &quot;com.sun.star.ucb.SimpleFileAccess&quot; )
		oFS = oSFA.openFileRead ( ConvertToURL (sFilename) )
		oTIS = createUnoService ( &quot;com.sun.star.io.TextInputStream&quot; )
		oTIS.setInputStream (oFS)
		Do While ( NOT oTIS.isEOF() )
			sLine = oTIS.readLine()
			If sLine &lt;&gt; &quot;&quot; Then
				&apos; Устанавливаем данные профиля
				If nN = 0 Then &apos; профиль Автора Книги
					SetBookAuthorProfile(sLine)
				ElseIf nN = 1 Then &apos; профиль Автора fb2-документа
					SetFB2AuthorProfile(sLine)
				ElseIf nN = 2 Then &apos; профиль Издательства
					SetPublisherProfile(sLine)
				End If
			End If
		Loop
		oTIS.closeInput()
	End If
End Sub

&apos; загрузка профиля
Sub _LoadProfile( sTitle As String, nN As Integer )
	&apos; nN - идентификатор типа профиля: 0 - для Автора Книги, 1 - для Автора fb2-документа, 2 - для Издательства
	Dim oFileDlg As Object
	Dim sArg() As String
	
	If (Not GlobalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;)) Then
		GlobalScope.BasicLibraries.LoadLibrary(&quot;Tools&quot;)
	End If

	oFileDlg = CreateUnoService(&quot;com.sun.star.ui.dialogs.FilePicker&quot;)
	sArg() = Array(com.sun.star.ui.dialogs.TemplateDescription.FILEOPEN_SIMPLE)
	
	With oFileDlg
		.initialize(sArg())
		.appendFilter(&quot;Profile files (.txt)&quot;, &quot;*.txt;*.TXT&quot;)
		.appendFilter(&quot;All files (.*)&quot;, &quot;*.*&quot;)
		.setTitle( sTitle )
	End With
	If oFileDlg.execute() Then
		&apos; Читаем установки и задаем значения контролам
		_ReadProfile( oFileDlg.Files(0), nN )
	End If
	oFileDlg.Dispose()
End Sub

&apos; Сохранение профиля
Sub _SaveProfile( sTitle As String, nN As Integer )
	&apos; nN - идентификатор типа профиля: 0 - для Автора Книги, 1 - для Автора fb2-документа, 2 - для Издательства
	Dim oFileDlg	As Object
	Dim sArg()		As String
	Dim sFile		As String
	
	If ( Not GlobalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) ) Then
		GlobalScope.BasicLibraries.LoadLibrary(&quot;Tools&quot;)
	End If

	oFileDlg = CreateUnoService( &quot;com.sun.star.ui.dialogs.FilePicker&quot; )
	sArg() = Array( com.sun.star.ui.dialogs.TemplateDescription.FILESAVE_AUTOEXTENSION )
	
	With oFileDlg
		.initialize(sArg())
		.appendFilter( &quot;Profile files (.txt)&quot;, &quot;*.txt;*.TXT&quot; )
		.appendFilter( &quot;All files (.*)&quot;, &quot;*.*&quot; )
		.setTitle( sTitle )
	End With
	If oFileDlg.execute() Then
		&apos; Читаем данные контролов профиля издательства и сохраняем в файл профиля для издательства
		Dim oOS As Object, oFA As Object, oTOS As Object

		oFA = CreateUnoService( &quot;com.sun.star.ucb.SimpleFileAccess&quot; )
		oTOS = CreateUnoService( &quot;com.sun.star.io.TextOutputStream&quot; )
		
		sFile = ConvertFromUrl( oFileDlg.Files(0) )
		IF ( InStr(sFile,&quot;.txt&quot;)=0 ) Then
			sFile = sFile + &quot;.txt&quot;
		End If

		oOS = oFA.openFileWrite(sFile)
		oOS.truncate()
		oTOS.setOutputStream(oOS)
		oTOS.setEncoding(&quot;utf-8&quot;)
		
		&apos; Сохраняем данные профиля
		Dim oLB As Object
		If nN = 0 Then &apos; профиль Автора Книги
			oTOS.writeString(&quot;tiFirst=&quot; &amp; oInfoDlg.Model.tiFirst.Text &amp; chr(10))
			oTOS.writeString(&quot;tiMiddle=&quot; &amp; oInfoDlg.Model.tiMiddle.Text &amp; chr(10))
			oTOS.writeString(&quot;tiLast=&quot; &amp; oInfoDlg.Model.tiLast.Text &amp; chr(10))
			oTOS.writeString(&quot;tiNickname=&quot; &amp; oInfoDlg.Model.tiNickname.Text &amp; chr(10))
			oTOS.writeString(&quot;tiEmail=&quot; &amp; oInfoDlg.Model.tiEmail.Text &amp; chr(10))
			oTOS.writeString(&quot;tiHomepage=&quot; &amp; oInfoDlg.Model.tiHomepage.Text &amp; chr(10))
			oLB = oInfoDlg.getControl(&quot;GenreComboBox&quot;)
			oTOS.writeString(&quot;GenreComboBox=&quot; &amp; oLB.SelectedItemPos &amp; chr(10))
			oLB = oInfoDlg.getControl(&quot;LangComboBox&quot;)
			oTOS.writeString(&quot;LangComboBox=&quot; &amp; oLB.SelectedItemPos &amp; chr(10))
			oLB = oInfoDlg.getControl(&quot;SrcLangComboBox&quot;)
			oTOS.writeString(&quot;SrcLangComboBox=&quot; &amp; oLB.SelectedItemPos &amp; chr(10))
		ElseIf nN = 1 Then &apos; профиль Автора fb2-документа
			_SaveFB2AuthorProfile( oTOS )
		ElseIf nN = 2 Then &apos; профиль Издательства
			oTOS.writeString(&quot;pubPublisherTextField=&quot; &amp; oInfoDlg.Model.pubPublisherTextField.Text &amp; chr(10))
			oTOS.writeString(&quot;pubCityTextField=&quot; &amp; oInfoDlg.Model.pubCityTextField.Text &amp; chr(10))
		End If
		oTOS.writeString(&quot;end of file&quot; &amp; chr(10))
		oTOS.closeOutput()
	End If
	oFileDlg.Dispose()
End Sub

&apos; записываем профиль автора fb2-файла
Sub _SaveFB2AuthorProfile( oTOS As Object )
	oTOS.writeString(&quot;diFirstField=&quot; &amp; oInfoDlg.Model.diFirstField.Text &amp; chr(10))
	oTOS.writeString(&quot;diMiddleField=&quot; &amp; oInfoDlg.Model.diMiddleField.Text &amp; chr(10))
	oTOS.writeString(&quot;diLastField=&quot; &amp; oInfoDlg.Model.diLastField.Text &amp; chr(10))
	oTOS.writeString(&quot;diNicknameField=&quot; &amp; oInfoDlg.Model.diNicknameField.Text &amp; chr(10))
	oTOS.writeString(&quot;diEmailField=&quot; &amp; oInfoDlg.Model.diEmailField.Text &amp; chr(10))
	oTOS.writeString(&quot;diHomepageField=&quot; &amp; oInfoDlg.Model.diHomepageField.Text &amp; chr(10))
	oTOS.writeString(&quot;diOCRField=&quot; &amp; oInfoDlg.Model.diOCRField.Text &amp; chr(10))
	oTOS.writeString(&quot;diURLField=&quot; &amp; oInfoDlg.Model.diURLField.Text &amp; chr(10))
	oTOS.writeString(&quot;HistoryTextField=&quot; &amp; oInfoDlg.Model.HistoryTextField.Text &amp; chr(10))
End Sub

&apos;//////////////////////////////////////////////////
&apos;/// Профиль Автора fb2-документа по-умолчанию ////
&apos;//////////////////////////////////////////////////
&apos; загрузка профиля Автора fb2-файла по-умолчанию
Sub ReadDefFB2AuthorProfile()
	If MsgBox( sIDD.sProfileFB2AuthorQuestionLoad, 128 + 32 + 1, sConvertorName ) = 2 Then
		Exit Sub
	End If
	&apos; Читаем установки и задаем значения контролам профиля автора документа fb2
	_ReadProfile( getOOoFBToolsSettingsDir() &amp; sConstFB2AuthorProfile, 1 )
End Sub

Sub SaveDefFB2AuthorProfile()
	&apos; записываем профиль автора fb2-файла по-умолчанию
	If MsgBox( sIDD.sProfileFB2AuthorQuestionSave, 128 + 32 + 1, sConvertorName ) = 2 Then
		Exit Sub
	End If
	Dim oOS As Object, oFA As Object, oTOS As Object
	Dim SFile As String : sFile = getOOoFBToolsSettingsDir() &amp; sConstFB2AuthorProfile

	oFA = CreateUnoService(&quot;com.sun.star.ucb.SimpleFileAccess&quot;)
	oTOS = CreateUnoService(&quot;com.sun.star.io.TextOutputStream&quot;)
	oOS = oFA.openFileWrite( sFile )
	oOS.truncate()
	oTOS.setOutputStream(oOS)
	oTOS.setEncoding(&quot;utf-8&quot;)
	_SaveFB2AuthorProfile( oTOS )
	oTOS.writeString(&quot;end of file&quot; &amp; chr(10))
	oTOS.closeOutput()
End Sub

Sub SetFB2AuthorProfile( sCurrentLine )
	On Error Goto ErrorHandler
	Dim sProfile() As String
	
	sProfile = Split(sCurrentLine, &quot;=&quot;)
	Select Case sProfile(0)
		Case &quot;diFirstField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diMiddleField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diLastField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diNicknameField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diEmailField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diHomepageField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diOCRField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;diURLField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;HistoryTextField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
	End Select
	Exit Sub
	
	ErrorHandler: &apos; Идем дальше
End Sub

&apos;/////////////////////////////////////
&apos;/// Профиль Автора fb2-документа ////
&apos;/////////////////////////////////////
&apos; загрузка профиля Автора fb2-файла
Sub LoadFB2AuthorProfile()
	_LoadProfile( sIDD.sProfileFB2AuthorOpen, 1 )
End Sub

&apos; записываем профиль автора fb2-файла
Sub SaveFB2AuthorProfile()
	_SaveProfile( sIDD.sProfileFB2AuthorSave, 1 )
End Sub

&apos;//////////////////////////////
&apos;/// Профили Авторов Книги ////
&apos;//////////////////////////////
&apos; Загрузка Автора Книга из файла профиля этого Автора
Sub LoadBookAuthorProfile()
	_LoadProfile( sIDD.sProfileAuthorOpen, 0 )
End Sub

&apos; Сохранение Автора Книга в файл профиля этого Автора
Sub SaveBookAuthorProfile()
	If Trim(oInfoDlg.Model.tiFirst.Text) = &quot;&quot; AND Trim(oInfoDlg.Model.tiMiddle.Text) = &quot;&quot; AND _
		Trim(oInfoDlg.Model.tiLast.Text) = &quot;&quot; AND Trim(oInfoDlg.Model.tiNickname.Text) = &quot;&quot; AND _
		Trim(oInfoDlg.Model.tiEmail.Text) = &quot;&quot; AND Trim(oInfoDlg.Model.tiHomepage.Text) = &quot;&quot; Then
		MsgBox sIDD.sInfoDlgFillBookAuthor, 64, sConvertorName
		Exit Sub
	End If
	_SaveProfile( sIDD.sProfileAuthorSave, 0 )
End Sub

Sub SetBookAuthorProfile( sCurrentLine )
	On Error Goto ErrorHandler
	Dim sProfile() As String
	Dim oLB As Object
	sProfile = Split(sCurrentLine, &quot;=&quot;)

	Select Case sProfile(0)
		Case &quot;tiFirst&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;tiMiddle&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;tiLast&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;tiNickname&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;tiEmail&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;tiHomepage&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;GenreComboBox&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;LangComboBox&quot;
			oLB = oInfoDlg.getControl(&quot;LangComboBox&quot;)
			oLB.SelectItemPos(sProfile(1), True)
		Case &quot;SrcLangComboBox&quot;
			oLB = oInfoDlg.getControl(&quot;SrcLangComboBox&quot;)
			oLB.SelectItemPos(sProfile(1), True)
	End Select
	Exit Sub
	
	ErrorHandler: &apos; Идем дальше
End Sub

Sub ClearBookAuthorFields()
	&apos; Очистка всех полей для Автора Книги
	oInfoDlg.Model.tiFirst.Text = &quot;&quot;
	oInfoDlg.Model.tiMiddle.Text = &quot;&quot;
	oInfoDlg.Model.tiLast.Text = &quot;&quot;
	oInfoDlg.Model.tiNickname.Text = &quot;&quot;
	oInfoDlg.Model.tiEmail.Text = &quot;&quot;
	oInfoDlg.Model.tiHomepage.Text = &quot;&quot;
	Dim oLB As Object
	oLB = oInfoDlg.getControl(&quot;GenreComboBox&quot;)
	oLB.SelectItemPos(0, True)
End Sub

&apos;////////////////////////////
&apos;/// Профили Издательств ////
&apos;////////////////////////////
&apos; Загрузка данных Издательства из файла профиля этого Издательства
Sub LoadPublisherProfile()
	_LoadProfile( sIDD.sProfilePublisherOpen, 2 )
End Sub

&apos; Сохранение Автора Книга в файл профиля этого Автора
Sub SavePublisherProfile()
	If Trim(oInfoDlg.Model.pubPublisherTextField.Text) = &quot;&quot; AND Trim(oInfoDlg.Model.pubCityTextField.Text) = &quot;&quot; Then
		MsgBox sIDD.sInfoDlgFillPublisher, 64, sConvertorName
		Exit Sub
	End If
	_SaveProfile( sIDD.sProfilePublisherSave, 2 )
End Sub

Sub SetPublisherProfile( sCurrentLine )
	On Error Goto ErrorHandler
	Dim sProfile() As String
	sProfile = Split(sCurrentLine, &quot;=&quot;)
	Select Case sProfile(0)
		Case &quot;pubPublisherTextField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
		Case &quot;pubCityTextField&quot;
			oInfoDlg.GetControl(sProfile(0)).Text = sProfile(1)
	End Select
	Exit Sub
	
	ErrorHandler: &apos; идем дальше
End Sub

&apos; Очистка всех полей для Бумажной книги
Sub ClearPaperBookFields()
	oInfoDlg.Model.pubBookNameTextField.Text = &quot;&quot;
	oInfoDlg.Model.pubISBNTextField.Text = &quot;&quot;
	oInfoDlg.Model.pubPublisherTextField.Text = &quot;&quot;
	oInfoDlg.Model.pubCityTextField.Text = &quot;&quot;
	oInfoDlg.Model.pubYearTextField.Text = &quot;&quot;
	oInfoDlg.Model.pubSequenseTextField.Text = &quot;&quot;
	oInfoDlg.Model.pubSequenseNumberTextField.Text = &quot;&quot;
End Sub

</script:module>